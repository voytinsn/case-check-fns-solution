# Демонстрационное приложение для проверки контрагентов через API ФНС

Это приложение на Python для получения сведений о проверке контрагентов из API ФНС и их хранения в базе данных MySQL. Оно демонстрирует работу с API, обработку данных и логирование операций, предлагая удобное тестовое окружение с mock API для разработки без ограничений реального API ФНС.

## Быстрый старт

### Требования
- **Docker** (для запуска тестового окружения)
- **Python 3.9+**
- Зависимости (устанавливаются через `requirements.txt`):
  - `mysql-connector-python`
  - `pydantic`
  - `python-dotenv`

### Установка
1. **Клонируйте репозиторий**:
   ```bash
   git clone https://github.com/voytinsn/case-check-fns-solution.git
   cd case-check-fns-solution
   ```

2. **Запустите тестовое окружение**:
   ```bash
   docker compose up -d
   ```
   После запуска база данных `crm` доступна на `127.0.0.1:3306` (логин/пароль: `root`), а веб-интерфейс phpMyAdmin — на `http://127.0.0.1:8080`. Подождите 15–20 секунд для инициализации.

3. **Подготовьте переменные окружения**:
   ```bash
   mv example.env .env
   ```

4. **Создайте виртуальное окружение**:
   - **MacOS/Linux**:
     ```bash
     python3 -m venv venv
     source venv/bin/activate
     ```
   - **Windows**:
     ```cmd
     python -m venv venv
     venv\Scripts\activate
     ```

5. **Установите зависимости**:
   ```bash
   pip install -r requirements.txt
   ```

6. **Запустите приложение**:
   ```bash
   python src/main.py
   ```

## Тестовое окружение

Тестовое окружение включает контейнеры MySQL, phpMyAdmin и mock API, запускаемые одной командой:
```bash
docker compose up -d
```

Остановка и удаление контейнеров:
```bash
docker compose down
```

### MySQL
- **Адрес**: `127.0.0.1:3306`
- **Логин/пароль**: `root`
- **База данных**: `crm`
- Инициализация: Тестовые данные загружаются из `mysql/init.sql`. Данные не сохраняются на диске; для сброса пересоздайте контейнеры.

### phpMyAdmin
- Доступен на `http://127.0.0.1:8080` для просмотра и редактирования базы данных через веб-интерфейс.

### Mock API
- Эндпоинт: `http://127.0.0.1:8000/api/check?req=<ИНН>`
- Пример: `http://127.0.0.1:8000/api/check?req=2312205769`
- Имитирует API ФНС, возвращая данные только для контрагентов из базы `crm`. Используется для разработки без ограничения в 100 запросов на бесплатном тарифе ФНС.

## Описание решения

Это решение автоматизирует получение сведений о контрагентах из API ФНС, их валидацию и хранение в MySQL. Оно разработано с акцентом на простоту, надёжность и удобство тестирования.

### Основные возможности
- **Получение данных**: Запросы к API ФНС или mock API для проверки контрагентов по ИНН.
- **Валидация**: Использование Pydantic для создания и проверки моделей данных (`Client` и `NegativeInfo`).
- **Хранение**: Работа с таблицами `clients` и `negative_info` через параметризованные SQL-запросы.
- **Логирование**: Вывод логов в `stdout`.
- **Тестирование**: Локальное окружение с mock API позволяет разрабатывать без ограничений реального API.

### Архитектура
- **Точка входа**: `src/main.py` — запускает приложение и управляет основным потоком.
- **Модели данных**:
  - `entities/client.py`: Pydantic-модель для клиентов.
  - `entities/negative_info.py`: Pydantic-модель для негативной информации.
- **Модели БД**:
  - `models/base_model.py`: Базовый класс для подключения к MySQL.
  - `models/clients_model.py`: Управление таблицей `clients`.
  - `models/negative_info_model.py`: Управление таблицей `negative_info`.
- **Конфигурация**: Переменные окружения в `.env`, для работы с реальным API ФНС требуется исправить значения API_KEY и API_URL.

### Технические решения
- **Без ORM**: Используется `mysql-connector-python` с нативными SQL-запросами для простоты и контроля.
- **Pydantic v2**: Модели используют `model_dump` для сериализации, обеспечивая валидацию и поддержку кириллических алиасов (например, `Статус`).
- **Логирование**: Реализовано через `logging` c выводом в stdout.
- **Mock API**: Позволяет тестировать без затрат реальных запросов к API ФНС.

## Замечания
- **Ограничение API ФНС**: Бесплатный тариф позволяет 100 запросов в сутки. Для продакшена используйте реальный `API_KEY` и `API_URL` в `.env`.
- **Ограничение по IP**: API ФНС привязано к IP, указанному при регистрации. Изменить IP можно в личном кабинете ФНС.
- Контейнеры тестового окружения слушают порты только на локальном интерфейсе 127.0.0.1, к ним не будет доступа с других компьютеров сети.